name: Code Quality

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: read

jobs:
  quality:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better analysis

      - name: Install Qlty
        uses: qltysh/qlty-action/install@v1

      - name: Run Qlty Check
        uses: qltysh/qlty-action/check@v1
        with:
          # Only check changed files in PRs
          all: ${{ github.event_name == 'push' }}
          level: medium

      # Optional: Upload coverage if you have tests
      # - name: Run tests with coverage
      #   run: bun test --coverage

      # - name: Upload coverage to Qlty
      #   uses: qltysh/qlty-action/coverage@v1
      #   with:
      #     path: coverage/coverage.xml
      #     tag: unit

  format:
    name: Code Formatting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Qlty
        uses: qltysh/qlty-action/install@v1

      - name: Check formatting
        run: |
          ~/.qlty/bin/qlty fmt --check
        continue-on-error: true # Don't fail the build for formatting issues
